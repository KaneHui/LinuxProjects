# 第3章 超级用户的权力

Linux系统上的每个文件和进程都属于特定的用户账号。如果没有得到属主的许可，其他用户就不能访问这些对象，因此，这条约定有助于防止用户彼此之间不管是有意还是无意的错误行为。

系统文件和进程属于一个称为root的虚拟用户，也叫做超级用户。与任何其他账号一样，root拥有的东西也受到保护，不受来自其他用户的干扰。要进行系统管理上的改动，需要使用本章中所描述的访问root账号的各种方法中的一种。

root账号具有几个“神奇"特性。root可以充当任何文件或进程的属主，还可以执行一些特殊操作，而其他用户是无权执行这些操作的。这个账号的权限非常大。

本章介紹管理员使用超级用户身份的基础知识。**第20章**介绍怎样避免出现不 必要和令人为难的由他人使用超级用户身份的情况。第30章介绍相关的政策和策略 方面的内容。


### 3.1文件和进程的归属关系 ###

每个文件都同时有一个属主(owner)和一个“属组(group owner)”。文件的属主拥有一种不和系统上任何用户共享的特殊权限，那就是修改文件访问权限的能力。具体而言，就是属主可以严格地设置文件的访问权限，让其他任何人都不能够访问这个文件匕我们将在**第5章**中讨论文件权限。

尽管文件的属主总是一个人，但许多人都可以成为文件的属组成员，只要他们全部是一个Linux组的成员即可。组原本在/etc/group文件中进行定义，但是现在用户组的信息保存在网络中的NIS或者LDAP服务器上的情形更为常见，参考第17章的内容了解详情。有关组的更多信息请参见6.1节。

文件的属主指定属组成员可以对文件进行哪些操作。这种机制能让同一个项目的成员之间共享文件。  一个文件的这两种归属关系都可以用ls filename命令来了解，例如：

	$ Is -1 /staff/scott/todo

	-rw	 1 scott staff 1258 Jun 4	18:15 /staff/scott/todo

这个文件的属主是用户“scott”，属组是“staff”组。

Linux实际上用数字来确定属主和属组，而不是用它们的文字名称。在最基本的情况下，用户标 识号（user identification numbers，简记为UID）被映射到/etc/passwd文件中的用户名上，而组标识号 （group identification numbers, GID）被映射到/etc/group文件中的组名上。定义与UID和GID相对应 的文字名称只是为了方便系统的现实用户使用。当诸如k这样的命令要以人们可以阅读的格式来显示 归属关系信息时，这些命令就必须在相应的文件或数据库中查出每个名字。

一个进程的属主可以向该进程发送信号（**参见4.3节**），还可以减小（降低）该进程的调度优先级。 进程实际上至少有7个与之相关的标识：一个真实（real） UID、一个有效（effective） UID和一个保 存（saved） UID； 一个真实GID、一个有效GID和一个保存GID;在Linux下，还有一个“文件系统 （filesystem） UID”，它只用来确定文件的访问权限。概括地说，“真实” ID用作记账，而“有效” ID 用来确定访问权限。一般情况下，真实ID和有效ID是相同的。

保存ID没有直接作用。它们能让程序“记下” 一个不活动的ID供以后使用，减少需要用过大特 权的机会。文件系统ID—般按NFS的实现细节来解释，通常和有效ID相同。

尽管通常对于一个进程来说不太可能会改变它自己的归属关系状态，但在一种特殊情形下，可以修改进程的有效UID和有效GID。**当执行设置了 “setuid”或“setgid”权限位的命令时，所得到的进程其有效UID或GID可以设置为包含该程序的映像文件的UID或GID,而不是设置为运行该命令的 用户的UID和GID。**这样一来，用户的权限就为此次执行该特定命令而得到“提升”。有关权限位的更多信息，请参见第5.5节。

利用Linux的setuid功能，普通用户可以以一种受限的并被严格控制的方式来使用root账号去运行程 序。例如，用户运行用来修改其登录口令的passwd命令就是一个setuid的程序。它以一种严格限定的方式去修改/etc/shadow （或者/etc/passwd）文件，然后退出执行。当然，即使是这类受限任务也有着被滥用的潜在可能，因此passwd命令在同意执行所请求的修改以前，要求用户证实他们知道当前账号的口令。


### 3.2超级用户 ###

root账号在定义上的特征是它的UID为0» Linux并没有不许用户修改这个账号上的用户名，也没有不许创建UID为0的其他账号，但这两种做法都是非常不好的。像这样的修改有可能无意中破坏 系统的安全性。同时，当其他人不得不适应以这种奇怪方式配置的系统时，也容易给他们带来混乱。

传统的UNIX允许超级用户（也就是有效UID为0的任何进程）在任何文件或进程上执行正当的操作2。此外，有些系统调用（对内核的请求）只能够由超级用户来执行，这类受限操作的一些例子有：

- 采用chroot命令来改变进程的根目录
- 创建设备文件
- 设置系统时钟
- 提高资源使用率的限度和进程的优先级3
- 设置系统的主机名称
- 配置网络接口
- 打开特权网络端口（那些编号小于1024的端口）
- 关闭系统
  
例如，超级用户有权改变属主为root的进程的UID和GID。login程序及其采用窗口形式的等价 程序都是这样的例子，这个在用户登录到系统时提示用户输入口令的进程起初就是以root权限运行的。 如果所输入的用户名和口令是合法的话，login就把它的UID和GID改变成为该用户的UID和GID并 启动该用户的用户环境。一旦一个以root权限执行的进程已经改变了它的归属关系而成为一个普通的 用户进程，那么它就不能再恢复它以前的特权状态了。

Linux系统从理论上说也能把root账号的特权按照POSIX标准中有关“权力（capability）”的规定再做细分。出于各种原因，其中也包括当前实现存在的问题，这项功能并没有其最初体现的那样有帮助，对于系统管理员来说也没有那么适合使用。有关权力的更多介绍，请参见20.6节。


### 3.3选择root的口令 ###

要牢记root口令，应该改变root的口令：

- 至少每3个月左右
- 每次当有个知道口令的人离开您的工作站点时
- 在认为安全性可能己经受到威胁的任何时候
- 当某一天，您没有料到晚上的聚会很累以致于第二天早上会忘记口令时


### 3.4成为root用户 ###

root不过是另一个用户而己，所以可以直接以root账号登录进入系统。然而，这种做法显得非常 糟糕。首先，这样做没有留下以root身份执行的操作的记录。当管理员意识到自己昨天夜里凌晨3:00 时损坏了某项内容，但又记不起来自己当时到底改变了什么时，这可就不妙了。当访问没有经过授权，而要试图找出入侵者对系统到底做了什么操作时，情况可能更糟。另外一个不利因素是以root身份登录进入系统的做法没有留下当时是谁真正做这项工作的记录。如果有几个人都有访问root账号的权限， 那么将不能够区分到底是谁在什么时候使用了root账号。

基于上述原因，**大多数系统禁止root在终端上以及通过网络来登录系统，或者说除了系统控制台之外的其他任何地方都禁止root登录**(4 Ubuntu Linux的限制更严。在默认情况下，系统没有合法的root 口令，要用sudo来获得root访问权，后面会详细介绍)。我们建议您使用这项特性，请参见20.9节以确定在您的特定系统上需要编辑哪个文件来配置这一功能。

#### 3.4.1	su：替换用户身份 ####

访问root账号稍好一些的方式是使用su命令。如果不带任何参数来调用su命令，那么它会提示 用户输入root的口令，然后启动一个root shell。这个shell的特权一直到shell终止（通过<Control-D> 或exit命令来终止）以前都保持有效。su不记录以root身份执行了哪些命令，但它确实会创建一条日志记录来说明是谁在什么时候变成了 root。

su命令也可以替代除了root以外的其他用户身份。有时候，重现或者调试用户问题的惟一方法就是su为该用户的账号，以便能够重现发生问题的环境。

如果知道某人的口令，那么通过执行su username就能够直接访问这个人的账号。与su到root账号的情况一样，此时也会提示用户输入username的口令。你也可以首先su到root账号，然后再su到其他账号，root账号不需提供密码就可以su到其他任何账号。

最好是键入su命令的完整路径（例如，/bin/su）,而不是依靠shell为你找到这个命令。这将在一定程度上防范己经溜入到搜索路径下的名为su的程序，它们带有想要获取口令的企图(**由于相同的原因，我们强烈建议您在shell的搜索路径中不要包括"."（当前目录）。虽然这样做会带来方便，但是该配置很容易意外地运行用户或入侵者作为陷阱留下的系统命令的特殊版本。自然，本忠告对于root用户加倍重要**)。


#### 3.4.2	sudo：受限的 su ####

由于超级用户账号的特权不可分割（至少不能随意分割），所以很难既给某个人完成一件任务的权力（例如，备份）而又不给这个人自由运行系统的权力。而且如果root账号由几个管理员使用，那么对于是谁正在使用这个账号或者谁使用这个账号做了什么事情就只有非常模糊的认识了。

针对这些问题，最广泛采用的解决方案是使用一个叫做sudo的程序，这个程序目前由Todd Miller 维护。我们所举的Linux发行版本都提供了这个软件。

sudo采用命令行作为参数，然后以root身份（或另外一个受限用户）执行。sudo读取文件 **/etc/sudoers**,这个文件列出了授权使用sudo的人以及允许他们在每台主机上运行的命令。如果提供 给sudo的命令允许运行，那么sudo就提示输入这个用户自己的口令并执行命令。

使用sudo的用户随后可以执行其他一些sudo命令而不用再输入口令，除非在超过5min （时间长度是可以配置的）的时间内该用户没有再使用sudo。这段超时时间可以作为一种最友善的保护，防止 具有sudo特权的用户由于不注意而长时间地离开终端所造成的安全隐患。

sudo保存有一个日志，它记录执行的命令行、命令行执行的主机、请求执行命令行的人、运行命令行的目录以及命令行被调用的时间。这些信息可以通过syslog进行记录或者被放入选定的文件中。 我们推荐使用**syslog**把日志项转发给一个安全的中央主机。

用户randy执行sudo/bin/cat/etc/sudoers命令会产生类似下面的一条日志记录：

	Dec 7 10:57:19 tigger sudo: randy: TTY=ttypO ; PWD=/tigger/users/randy; USER=root ; COMMAND=/bin/cat /etc/sudoers

文件sudoers的设计做到了仅用一个版本就可以立即用在许多不同的主机上。下面是一个典型的例子：

	#	Define aliases for machines in CS & Physics departments
	
	Host_Alias CS = tigger, anchor, piper, moet, sigi 
	Host_Alias PHYSICS = eprince, pprince, icarus
	
	#	Define collections of commands 
	
	Cmnd_Alias DUMP = /sbin/dump, /sbin/restore Cmnd_Alias PRINTING = /usr/sbin/Ipc, /usr/bin/lprm	
	Cmnd_Alias SHELLS = /bin/sh, /bin/tcsh, /bin/bash, /bin/ash, /bin/bsh
	
	#	Permissions	.
	
	mark, ed	PHYSICS = ALL	
	herb	CS = /usr/sbin/tcpdump : PHYSICS = （operator） DUMP	
	lynda	ALL = （ALL） ALL, !SHELLS	
	%wheel ALL, !PHYSICS = NOPASSWD: PRINTING

前5个非注释行定义了主机组和命令组，这些组供这个文件后面的权限说明来引用。这个列表可 以原封不动地逐字包括在说明中，但使用别名会让sodners文件更容易阅读和理解，还能让文件以后 更容易更新。还可以为用户集合或以其身份运行命令的用户集合定义别名。

每一行权限说明包括的信息如下:

- 这一行所适用的用户
- 应该注意这一行的主机
- 指定用户可以运行的命令
- 可以以其身份执行命令的用户

第1行权限说明适用于PHYSICS组机器（eprince、pprince和icarus）上的用户mark和ed。sudo 内建的命令别名ALL允许他们运行任何命令。由于在小括号中没有指定用户列表，所以sudo将只以 root身份运行命令。

第2行权限说明允许用户herb在CS组机器上运行tcpdump,并在PHYSICS组机器上运行与dump 有关的命令。不过，dump命令只能够以operator的身份而不能以root身份运行。用户herb键入的实际命令行则类似下面这样：

	$ sudo -u operator /sbin/dump Ou /dev/hda2

用户lynda能够以任何用户的身份在任何机器上运行命令，但不能够运行几个普通的shell,难道 这就意味着lynda不能够得到一个root shell?当然不是：

	$ cp -p /bin/bash /tmp/bash	
	$ sudo /tmp/bash

一般说来，任何试图设定"除……以外的所有命令”的做法都注定要失败，至少在技术角度来看 是这样。但是，按照这种方式建立一个sudoers文件，作为不鼓励使用root shell的提醒信息仍然是值得的。这种做法可能会避免用户不经意的使用。

最后一行允许组“wheel”中的用户以root身份在除了 eprince, pprince和icarus之外的任何机器上运行Ipc和Iprm。而且运行这些命令不需要任何口令。

注意，/etc/sudoers中的命令采用完整路径来指定，这样做是为了防止人们以root身份去执行他们自己的程序和脚本。尽管上面没有给出例子，但可以为每个命令指定允许的参数。事实上，sudoers 文件的功能相当强大，这个简单的配置只涉及到它的一点点功能，

**要修改/etc/sudoers,请使用visudo命令**，这个命令检査以确保没有其他人正在编辑这个文件，接着调用一个编辑器编辑该文件，然后先验证文件编辑修改后的语法无误，再安装它。最后这一步骤尤其重要，因为无效的sudoers文件可能会不让用户再用sudo去修复它。

使用sudo具有以下一些好处：

- 由于有命令日志，因而极大地提髙了安全审计的能力
- 操作员不需要不受限制的root特权就能够完成许多任务
- 真正的root 口令可以只让一两个人知道
- 使用sudo比运行SU或者以root身份登录进入系统要快
- 不需要改变root的口令就能够收回一些特权
- 维护一个具有root特权的所有用户的规范列表
- 不经意遗留root shell的概率降低了许多
- 可以使用单个文件来控制对整个网络的访问权限

sudo当然也有一些不足之处。其中最糟糕的是，如果突破了能执行sudo命令的个人账号的安全防线，就等同于突破了 root账号本身的安全防线。对付这种威胁除了提醒能执行sodo命令的用户在他们暂时成为root时保护好自己的账号之外，就没有其他什么措施了。也可用John the Ripper程序尝试破解一下sudoer的口令,确保用户选择了良好的口令。参考20.10节了解有关John the Ripper 程序的更多知识。

sudo的命令日志机制可以用一些技巧暗中破坏，比如在允许执行的程序中使用shell的转义字符， 或者如果允许sudo sh和sudo su的话，则利用它们来破坏。

### 3.5其他的伪用户 ###

在内核看来，root是具有特殊地位的惟一用户，但系统还定义了另外几个伪用户。惯用的做法是用星号来替代这些特殊用户在/etc/passwd中被加密的口令字段，从而让这些用户的账号不能用来登录进入系统。

#### 3.5.1	bin：系统命令的老属主 ####

在一些比较老的UNIX系统上，bin用户是包含系统命令的那些目录的属主，还是大多数命令本身的属主。如今这种账号经常被看作是多余的（或者甚至可能有些不安全），因此现代系统（包括Linux）通常就只使用root账号了。另一方面，既然bin账号是“标准”账号，所以还真的不能废除它。

#### 3.5.2	daemon：无特权系统软件的属主 ####

有些文件和进程是操作系统的一部分，但不需要由root做其属主，这样的文件和进程就给了daemon。其中的道理是，这种约定能有助于避免采用root做属主所带来的危险。出于类似的原因，还有一个叫做“daemon”的组。和bin账号类似，大多数Linux发行版本也不怎么用daemon账号。

#### 3.5.3	nobody:普通 NFS 用户 ####

网络文件系统（Network File System, NFS）在进行文件共享的时候，使用nobody账号代表其他 系统上的root用户。为了去掉远程root用户的特权，远程UID为0的用户必须被映射成本地UID 0 之外的某个用户。nobody账号就充当了这些远程root用户的一般替身。参考16.1节了解有关nobody 账号的更多信息=

由于nobody账号应该代表一个普通的、权力相对来说比较小的用户，因此这个账号不应该拥有 任何文件。如果nobody账号确实拥有文件的话，那么远程的root就可以控制这些文件。nobody不应 该拥有任何文件！

传统上给nobody用户的UID是-1或者-2, Linux内核仍然默认用UID 65534 （-2的16位二进制补码）。有些发行版本给nobody指派一个小编号的UID（例如，Red Hat和Fedora使用9），这样做比 65534更合理，因为UID是32位的。惟一有问题的地方是exportfs命令似乎不去看passwd文件，所以必须用anonuid选项明确告诉它给nobody用一个不同的UID

### 3.6习题 ###

- E3.1使用带有-perm选项的find命令在您的系统上找到5个setuid文件。对于每个文件， 试述为什么对于让命令正确发挥其功能来说，setuid机制是必要的。

- E3.2创建三个“出人意料的废话”式口令词，但是要保密。通过运行md5sUm程序处理 这三个口令词，报告结果。为什么公开MD5结果是安全的？

- E3.3列举一系列修改某个用户口令的命令，展示如何掩盖修改的痕迹。假定您只有sudo 的权利（允许使用除shell或者su之外的所有命令）。

- E3.4为sudoers配置文件创建两项：

	a）	—项让用户matt、adam和drew负责在printserver这台机器上为打印机服务，消 除夹纸，然后重新启动打印机的守护进程；

	b）	一项让drew、smithgr和jimlane终止学生机房里机器上的任务并重启机器。 

- E3.5安装sudo,配置成让它把有关误用的邮件发给您。以本地用户名和机器名来测试上一个问题中的sudo配置项；验证sudo是香能正滴地把日志写到syslog。检查测试在syslog中生成的日志项（需要root访问权限，很可能述要调整一下**/etc/syslog.conf**）。